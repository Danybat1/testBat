<div class="cash-statement-container">
  <!-- En-tête avec filtres -->
  <mat-card class="filter-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>account_balance_wallet</mat-icon>
        Relevé de Caisse
      </mat-card-title>
    </mat-card-header>
    
    <mat-card-content>
      <form [formGroup]="filterForm" (ngSubmit)="onFilterChange()">
        <div class="filter-row">
          <mat-form-field appearance="outline" class="date-field">
            <mat-label>Date de début</mat-label>
            <input matInput type="date" formControlName="startDate" (change)="onFilterChange()">
            <mat-icon matSuffix>calendar_today</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" class="date-field">
            <mat-label>Date de fin</mat-label>
            <input matInput type="date" formControlName="endDate" (change)="onFilterChange()">
            <mat-icon matSuffix>calendar_today</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" class="currency-field">
            <mat-label>Devise</mat-label>
            <mat-select formControlName="currency" (selectionChange)="onFilterChange()">
              <mat-option *ngFor="let currency of currencies" [value]="currency.value">
                {{ currency.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <div class="action-buttons">
            <button mat-raised-button color="primary" type="submit" [disabled]="loading">
              <mat-icon>refresh</mat-icon>
              Actualiser
            </button>
            
            <button mat-raised-button color="accent" (click)="printStatement()" [disabled]="!cashStatement">
              <mat-icon>print</mat-icon>
              Imprimer
            </button>
            
            <button mat-raised-button (click)="exportToExcel()" [disabled]="!cashStatement">
              <mat-icon>file_download</mat-icon>
              Excel
            </button>
          </div>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Résumé de la période -->
  <mat-card class="summary-card" *ngIf="cashStatement">
    <mat-card-header>
      <mat-card-title>
        Résumé de la période
        <span class="period-text" *ngIf="cashStatement.startDate && cashStatement.endDate">
          ({{ cashStatement.startDate | date:'dd/MM/yyyy' }} - {{ cashStatement.endDate | date:'dd/MM/yyyy' }})
        </span>
      </mat-card-title>
    </mat-card-header>
    
    <mat-card-content>
      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-label">Solde d'ouverture</div>
          <div class="summary-value opening-balance">
            {{ formatCurrency(cashStatement.openingBalance) }}
          </div>
        </div>
        
        <div class="summary-item">
          <div class="summary-label">Total encaissements</div>
          <div class="summary-value encaissement">
            <mat-icon>arrow_upward</mat-icon>
            {{ formatCurrency(cashStatement.totalEncaissements) }}
          </div>
        </div>
        
        <div class="summary-item">
          <div class="summary-label">Total décaissements</div>
          <div class="summary-value decaissement">
            <mat-icon>arrow_downward</mat-icon>
            {{ formatCurrency(cashStatement.totalDecaissements) }}
          </div>
        </div>
        
        <div class="summary-item closing-balance-item">
          <div class="summary-label">Solde de clôture</div>
          <div class="summary-value closing-balance">
            <mat-icon>account_balance</mat-icon>
            {{ formatCurrency(cashStatement.closingBalance) }}
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Tableau des opérations -->
  <mat-card class="operations-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>list</mat-icon>
        Détail des opérations
        <span class="operations-count" *ngIf="dataSource.data.length > 0">
          ({{ dataSource.data.length }} opération{{ dataSource.data.length > 1 ? 's' : '' }})
        </span>
      </mat-card-title>
    </mat-card-header>
    
    <mat-card-content>
      <!-- Indicateur de chargement -->
      <div class="loading-container" *ngIf="loading">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Chargement du relevé...</p>
      </div>

      <!-- Tableau des opérations -->
      <div class="table-container" *ngIf="!loading">
        <table mat-table [dataSource]="dataSource" class="operations-table">
          <!-- Colonne Date -->
          <ng-container matColumnDef="operationDate">
            <th mat-header-cell *matHeaderCellDef>Date</th>
            <td mat-cell *matCellDef="let operation">
              {{ operation.operationDate | date:'dd/MM/yyyy' }}
            </td>
          </ng-container>

          <!-- Colonne Référence -->
          <ng-container matColumnDef="reference">
            <th mat-header-cell *matHeaderCellDef>Référence</th>
            <td mat-cell *matCellDef="let operation">
              <span class="reference-text">{{ operation.reference }}</span>
            </td>
          </ng-container>

          <!-- Colonne Type d'opération -->
          <ng-container matColumnDef="operationType">
            <th mat-header-cell *matHeaderCellDef>Type</th>
            <td mat-cell *matCellDef="let operation">
              <mat-chip [ngClass]="getOperationTypeClass(operation.operationType)">
                {{ getOperationTypeLabel(operation.operationType) }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Colonne Client/Fournisseur -->
          <ng-container matColumnDef="clientSupplier">
            <th mat-header-cell *matHeaderCellDef>Client/Fournisseur</th>
            <td mat-cell *matCellDef="let operation">
              {{ operation.clientSupplier }}
            </td>
          </ng-container>

          <!-- Colonne Description -->
          <ng-container matColumnDef="description">
            <th mat-header-cell *matHeaderCellDef>Description</th>
            <td mat-cell *matCellDef="let operation">
              <span class="description-text" [title]="operation.description">
                {{ operation.description }}
              </span>
            </td>
          </ng-container>

          <!-- Colonne Encaissement -->
          <ng-container matColumnDef="encaissement">
            <th mat-header-cell *matHeaderCellDef class="amount-header">Encaissement</th>
            <td mat-cell *matCellDef="let operation" class="amount-cell">
              <span *ngIf="operation.operationType.includes('ENCAISSEMENT')" class="encaissement">
                {{ formatCurrency(operation.amount, operation.currency) }}
              </span>
            </td>
          </ng-container>

          <!-- Colonne Décaissement -->
          <ng-container matColumnDef="decaissement">
            <th mat-header-cell *matHeaderCellDef class="amount-header">Décaissement</th>
            <td mat-cell *matCellDef="let operation" class="amount-cell">
              <span *ngIf="operation.operationType === 'DECAISSEMENT'" class="decaissement">
                {{ formatCurrency(operation.amount, operation.currency) }}
              </span>
            </td>
          </ng-container>

          <!-- Colonne Solde -->
          <ng-container matColumnDef="balance">
            <th mat-header-cell *matHeaderCellDef class="amount-header">Solde</th>
            <td mat-cell *matCellDef="let operation" class="amount-cell">
              <span class="balance">
                {{ formatCurrency(operation.balance, operation.currency) }}
              </span>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>

        <!-- Message si aucune opération -->
        <div class="no-operations" *ngIf="dataSource.data.length === 0">
          <mat-icon>inbox</mat-icon>
          <h3>Aucune opération trouvée</h3>
          <p>Aucune opération de caisse n'a été trouvée pour la période sélectionnée.</p>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>
